name: Build Image and Upload
on:
  workflow_dispatch: {}        # Manual trigger
  schedule:
    # Every Friday 20:30 UTC â†’ Saturday 2:00 AM IST
    - cron: '30 20 * * 5'
jobs:
  build-release-upload:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [gnome, plasma]
      fail-fast: false
    env:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
    steps:
      - name: Checkout shani-install-media repository
        uses: actions/checkout@v4
        with:
          repository: shani8dev/shani-install-media
          path: shani-install-media
          clean: true
          fetch-depth: 0
      
      - name: Make scripts executable
        run: |
          cd shani-install-media
          chmod +x run_in_container.sh build.sh
      
      - name: Setup MOK keys
        run: |
          cd shani-install-media
          mkdir -p mok
          echo "${{ secrets.MOK_KEY }}" > mok/MOK.key
          echo "${{ secrets.MOK_CRT }}" > mok/MOK.crt
          echo "${{ secrets.MOK_DER_B64 }}" | base64 --decode > mok/MOK.der
      
      - name: Build Artifacts for ${{ matrix.profile }}
        run: |
          cd shani-install-media
          echo "Building image artifacts for profile: ${{ matrix.profile }}"
          sudo env SSH_PRIVATE_KEY="${SSH_PRIVATE_KEY}" \
                   GPG_PRIVATE_KEY="${GPG_PRIVATE_KEY}" \
                   GPG_PASSPHRASE="${GPG_PASSPHRASE}" \
                   R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
                   R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
                   R2_ACCOUNT_ID="${R2_ACCOUNT_ID}" \
                   R2_BUCKET="${R2_BUCKET}" \
          ./run_in_container.sh ./build.sh image -p "${{ matrix.profile }}"
      
      - name: Release Artifacts for ${{ matrix.profile }}
        run: |
          cd shani-install-media
          echo "Creating latest release for profile: ${{ matrix.profile }}"
          sudo env SSH_PRIVATE_KEY="${SSH_PRIVATE_KEY}" \
                   GPG_PRIVATE_KEY="${GPG_PRIVATE_KEY}" \
                   GPG_PASSPHRASE="${GPG_PASSPHRASE}" \
                   R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
                   R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
                   R2_ACCOUNT_ID="${R2_ACCOUNT_ID}" \
                   R2_BUCKET="${R2_BUCKET}" \
          ./run_in_container.sh ./build.sh release -p "${{ matrix.profile }}" latest
      
      - name: Upload Artifacts for ${{ matrix.profile }}
        run: |
          cd shani-install-media
          echo "Uploading artifacts for profile: ${{ matrix.profile }}"
          sudo env SSH_PRIVATE_KEY="${SSH_PRIVATE_KEY}" \
                   GPG_PRIVATE_KEY="${GPG_PRIVATE_KEY}" \
                   GPG_PASSPHRASE="${GPG_PASSPHRASE}" \
                   R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}" \
                   R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}" \
                   R2_ACCOUNT_ID="${R2_ACCOUNT_ID}" \
                   R2_BUCKET="${R2_BUCKET}" \
          ./run_in_container.sh ./build.sh upload -p "${{ matrix.profile }}" image
